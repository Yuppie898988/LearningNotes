# 机器视觉重点

## 数字图像的概念与性质

### 距离

#### 距离种类

- 欧氏距离：$D_E=\sqrt{(m-h)^2+(n-k)^2}$
- 城区距离：$D_4=|m-h|+|n-k|$
- 棋盘距离：$D_8=\max\{|m-h|,|n-k|\}$

#### 距离变换

给出图像中每个像素与某个图像子集的距离，算法如下：

1. 从上到下，从左至右遍历，$F(p)=\underset{q\in AL}{\min}\{F(p),D(p,q)+F(q)\}$
2. 从下到上，从右到左遍历，$F(p)=\underset{q\in BR}{\min}\{F(p),D(p,q)+F(q)\}$

### 边缘与边界

- 边缘：像素与其直接邻接的**局部性质**，是图像上亮度的不连续点，是矢量。**方向与梯度垂直，大小与梯度相等。**
- 边界是与区域有关的**全局概念**

### 噪声

- 加性噪声：噪声与图像信号无关
- 乘性噪声：噪声幅值与信号本身幅值有关

### 卷积

- 卷积定义：
$$
\begin{aligned}
g(x,y)&=f(x,y)*h(x,y)\\
&=\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}f(x-a,y-b)h(a,b)dadb
\end{aligned}
$$

- 若系统响应可以表示成卷积的形式，则该系统是一个线性移不变系统；
    任意线性移不变系统可以表示成卷积形式

- 离散卷积：
$$
\begin{aligned}
g(m,n)&=\sum_{k=0}^{M_2-1}\sum_{l=0}^{N_2-1}f(m-k,n-l)h(k,l)\\
&=\sum_{k=0}^{M_1-1}\sum_{l=0}^{N_1-1}f(k,l)h(m-k,n-l)
\end{aligned}
$$
其中$f(x,y)$尺寸是$M_1\times N_1$，$h(x,y)$尺寸是$M_2\times N_2$
卷积后尺寸为高为$M_1+M_2-1$，宽为$N_1+N_2-1$

## 图像预处理

### 像素亮度变换

- 亮度校正：**与像素位置相关**

- 灰度级变换：**与像素位置无关**，将原来在范围$[p_0,p_k]$内的亮度p变换为$[q_0,q_k]$内的亮度$q=T(p)$。

典型灰度级变换方法：

  1. 底片变换
  2. 分段增强
  3. 图像二值化

- 直方图均衡化：创建一副在整个亮度范围内有**相同亮度分布**的图像，增强靠近直方图极大值附近的亮度对比度，减小了极小值附近的对比度。
$$
\int_{p_0}^pH(s)ds=\int_{q_0}^q\frac{MN}{q_k-q_0}ds=\frac{MN(q-q_0)}{q_k-q_0}\\
q=\frac{q_k-q_0}{MN}\int_{p_0}^pH(s)ds+q_0\\
q=\frac{q_k-q_0}{MN}\sum_{s=p_0}^pH(s)+q_0
$$
在实际应用中$[p_0,p_k],[q_0,q_k]$一般固定为$[0,255]$，则
$$
q=\frac{255}{MN}\sum_{s=0}^pH(s)
$$

### 几何变换

#### 图像坐标变换

- 双线性变换（需要四个对应点对）
- 仿射变换（需要三个对应点对）

#### 亮度插值

确定对应于输出图像离散栅格点在**输入图像**中点，对**输入图像**进行亮度插值

- 利用插值核对原图像进行卷积运算
- 最近邻插值：$f'(x,y)=f(round(x),round(y))$
- 亮度插值：考虑四个相邻点，假设亮度线性。**减轻最近邻插值中出现的阶梯状直边界**
- 双三次插值：考虑16个相邻点，解决了**阶梯状边缘问题**和**模糊问题**，较好地保持了图像细节

### 局部预处理

#### 线性滤波

- 均值滤波：多次采集相同静态景物获得平均图像，噪声均值为0，标准差为$\frac{\sigma}{\sqrt{k}}$。如果就一张，则局部邻域平均滤波。
- 高斯滤波：基于高斯函数形成卷积核，便于**去除服从正态分布的噪声**

#### 非线性滤波

仅使用邻域中与被处理像素有**类似性质**的点进行平滑

- 设定数据范围$[\min,\max]$，只有在该范围内的像素值才对邻域平均有贡献
- 根据反梯度的平均
$$
\delta(i,j)=\frac{1}{|f(m,n)-f(i,j)|}
$$
其中如果$f(m,n)=f(i,j)$则$\delta(i,j)=2$；$(m,n)$为掩膜中心
加权系数：
$$
\begin{aligned}
\delta=\left\{
    \begin{aligned}
    &0.5 \quad 掩膜中心\\
    &0.5\frac{\delta(i,j)}{\sum\delta(i,j)}\quad 非掩膜中心
    \end{aligned}
\right.
\end{aligned}
$$
**区域像素比边缘像素权重更大**

- 旋转掩膜平均
![旋转掩膜](https://raw.githubusercontent.com/Yuppie898988/LearningNotes-images/main/images/678707FFCD5D373B5A261D0BFEFA1058.png)
计算该像素点在不同掩膜$h$中的方差：
$$
\sigma^2=\frac{1}{n}\{\sum_{(i,j)\in h}[f(i,j)-\frac{1}{n}\sum_{(i,j)\in h}f(i,j)]^2\}
$$
选择方差$\sigma^2$最小的掩膜，其均值即为该像素点最终结果

- 中值滤波：用像素邻域灰度值的中值代替该像素的灰度值,**便于去除脉冲噪声、椒盐噪声**
  1. 确定掩膜中心和掩膜大小
  2. 将掩膜内像素按亮度值大小排序
  3. 取中值，若为偶数则取中间两个的均值

### 边缘检测

1. 设计平滑滤波器$h$，计算$h',h''$
2. 检测$f*h'$局部最大值或者$f*h''$过零点

- 平滑滤波器特点:
  - $\lim\limits_{|x|\to \infty}h(x)=0$
  - h(x)为偶函数
  - $\int_{-\infty}^{\infty}h(x)dx=1$，**保证滤波后不改变原信号的均值**
  - 一阶二阶可微
- 常见算子
  - Robert
  $$
  h_1=\begin{bmatrix}
  -1 & 0 \\
  0 & 1 \\
  \end{bmatrix},
  h_2=\begin{bmatrix}
  0 & -1 \\
  1 & 0 \\
  \end{bmatrix}
  $$
  - Prewitt
  $$
  h_1=\begin{bmatrix}
  -1 & -1 & -1 \\
  0 & 0 & 0 \\
  1 & 1 & 1
  \end{bmatrix},
  h_2=\begin{bmatrix}
  -1 & 0 & 1 \\
  -1 & 0 & 1 \\
  -1 & 0 & 1
  \end{bmatrix}
  $$
  - Sobel
  $$
  h_1=\begin{bmatrix}
  -1 & -2 & -1 \\
  0 & 0 & 0 \\
  1 & 2 & 1
  \end{bmatrix},
  h_2=\begin{bmatrix}
  -1 & 0 & 1 \\
  -2 & 0 & 2 \\
  -1 & 0 & 1
  \end{bmatrix}
  $$
  - Laplacian
  $$
  h=\begin{bmatrix}
  0 & 1 & 0 \\
  1 & -4 & 1 \\
  0 & 1 & 0
  \end{bmatrix}
  $$
- $\sigma$越大，图像分辨率越低
- Canny边缘检测
  1. 与二维高斯函数做卷积，**消除噪声**
  2. 计算每个像素的梯度大小和方向
  3. 根据梯度方向，作非极大值抑制获取边缘位置
    3.1. 遍历非0梯度的像素，根据梯度方向找到两个邻接像素
    3.2. 若存在一个邻接像素梯度幅值大于该像素，则将该像素置零
    **注：在实际运用中邻接像素的幅值通过线性插值获得**
  4. 滞后阈值化处理/双阈值法
    4.1. 设置高低阈值
    4.2. 超过高阈值的设为边缘，弱于低阈值的舍弃
    4.3. 遍历处于高低阈值区间内的像素，若该像素与边缘邻接则标记为边缘
- 多尺度特征综合
  1. 标记最小尺度的边缘
  2. 高斯卷积后估计大尺度检测边缘位置（大尺度合成边缘响应）
  3. 大尺度滤波器检测（大尺度实际边缘响应）
  4. 实际边缘响应显著强于合成边缘响应，则接受此边缘点

### 图像复原

- 图像增强：使图像具有更好的视觉效果
- 图像复原：利用图像降质过程的先验知识建立**降质模型**，是降质的逆过程
- 逆滤波：退化函数已知，通过复原滤波器消除退化。适用于**没有被噪声污染**的情况
$$
\begin{align}
g(x,y)&=H[f(x,y)]+n(x,y)\\
g(x,y)&=h(x,y)*f(x,y)+n(x,y)\\
G(u,v)&=H(u,v)F(u,v)+N(u,v)\\
F(u,v)&=G(u,v)H^{-1}(u,v)-N(u,v)H^{-1}(u,v)
\end{align}
$$
H为退化函数，n为加性噪声，根据线性移不变性质可化为卷积形式(2)，再进行傅里叶变换(3)
- 维纳滤波：寻找使均方误差最小的估计$\hat f$

## 图像分割

### 阈值化

- p率阈值化：基于直方图选择阈值$T$，使得$\frac{1}{p}$的像素灰度值比$T$小
- 模式方法：寻找直方图两个局部极大值，取它们之间的极小值为阈值
- 最优阈值化：
  1. 设定初始阈值$t_0$
  2. 计算灰度值小于$t_0$的像素集合的平均值$\mu_1$，灰度值大于$t_0$的像素集合的平均值$\mu_2$
  3. 新阈值$t_1=\frac{\mu_1+\mu_2}{2}$
  4. 重复步骤2、3直到阈值变化足够小
- **OTSU阈值检测**：
  1. 将直方图除以像素总数，进行归一化，得到像素概率分布直方图$H$
  2. 划分背景$B$（灰度值小于等于$t$的像素）与前景$F$（灰度值大于$t$的像素）
  3. 背景、前景概率和均值计算：
  $$
  \begin{aligned}
  \omega_B(t)&=\sum_{i=0}^tH(i)\\
  \omega_F(t)&=\sum_{i=t+1}^{255}H(i)\\
  \mu_B(t)&=\sum_{i=0}^t\frac{iH(i)}{\omega_B}\\
  \mu_F(t)&=\sum_{i=t+1}^{255}\frac{iH(i)}{\omega_F}\\
  \mu&=\sum_{i=0}^{255}iH(i)
  \end{aligned}
  $$
  4. 计算类间方差:
  $$
  \sigma(t)=\omega_B(t)(\mu_B(t)-\mu)^2+\omega_F(t)(\mu_F(t)-\mu)^2
  $$
  5. 最优阈值$\hat t=\underset{t}{\argmax}(\sigma(t))$

### 边界跟踪

#### 内边界跟踪

1. 从左上方开始搜索，设定$dir=3(4-邻接)/7(8-邻接)$
2. 按逆时针方向搜索$3\times 3$邻域，初始方向为:
$$
\begin{aligned}
4-邻接跟踪：&dir=(dir+3)\mod 4\\
8-邻接跟踪：&dir=(dir+7)\mod 8（dir为偶数）\\
&dir=(dir+6)\mod 8（dir为奇数）
\end{aligned}
$$
**简单来说对于4邻接跟踪，更新后的$dir$为之前的$dir-1$（顺时针转45°）；对于8邻接跟踪，更新后的$dir$为之前的$dir$顺时针转至第一个奇数位**
例如：4邻接$dir=3$，更新后的$dir=2$；8邻接$dir=6或7$，更新后的$dir=5$
3. 当前像素等于第二个像素，且上一个像素等于第一个像素时停止；否则重复步骤2

#### 外边界跟踪

1. 进行4邻接跟踪
2. 搜索过程中**测试过的非内边界像素**组成外边界

#### 扩展边界

![扩展边界](https://raw.githubusercontent.com/Yuppie898988/LearningNotes-images/main/images/78C141B10499AD1C57A43F7F83A2C361.png)

- 边界形状与内边界完全相同，像素位置向下和向右平移了半个像素
- 对于内边界而言：扩展边界为内边界的上、左像素；右像素的右方、下方像素；下像素的下方、右方像素
- 对于外边界而言：扩展边界为上像素向右下移动1个像素；左像素向右移动1个像素；右像素向下移动1个像素
- 查找表法追踪边界：按照12种情况的表进行追踪
![查找表](https://raw.githubusercontent.com/Yuppie898988/LearningNotes-images/main/images/0A83D698A09B9EBCA4F123A4FC6C033F.png)

### 基于区域分割

- 分裂与归并：
  1. 金字塔数据结构种，任意区域不符合一致性测试，则分裂成四个子区域；如果具有相同父结点的四个区域具有一致性，则归并
  2. 执行步骤1至无法分裂与归并
  3. 归并任意两个具有一致性的邻接区域（可没有相同父结点）
  4. 如果必须删除小尺寸，则归并小区域和最相似的邻接区域
- 一致性规则可自定义，例如天鹅星座环的X射线频段图像中，需要分割出稀疏环（标准差较大且灰度值介于背景和中心区域之间）。此时可定义为一致性为$\sigma>10, 0<mean<125$.

### 分水岭分割

对于梯度幅值图像而言，盆地表示原图像平滑的地方。给定幅值初始值的情况下，每个幅值小于初始值的盆地表示一个区域。按照幅值大小从初始值往上遍历，对于新像素而言它将**分给离它邻接的盆地**。如果**它和两个盆地都邻接**，则为**分水岭**。如果它**没有邻接盆地**，则为**新盆地**。

## 数学形态学

### 二值图像形态学

- 反射：$\hat B=\{(-x,-y)|(x,y)\in B\}$
- 平移：$(B)_z=\{c|c=b+z, b\in B\}$
- 膨胀：$A\oplus B=\{z|(\hat B)_z\cap A \neq \varnothing\}$
- 腐蚀：$A\otimes B=\{z|(B)_z\subseteq A\}$
- 对偶性：
$$
(A\circleddash B)^c=A^c\oplus \hat B\\
(A\oplus B)^c=A^c\circleddash \hat B
$$
**对于原点对称结构元来说，对$A$背景膨胀的补集等于对$A$的腐蚀**
- 击中击不中变换：$A\textcircled{\times}B=(A\circleddash B_1\cap A^c\circleddash B_2)$，其中$B_1$为与目标匹配的模板，$B_2$为与目标背景匹配的模板。**用于在A中寻找与模板B匹配的元素**
- 开运算：$A\circ B=(A\circleddash B)\oplus B$，**平滑物体轮廓，断开狭颈，去掉细小突出**
- 闭运算：$A\bullet B=(A\oplus B)\circleddash B$，**平滑物体轮廓，弥合较窄间断和细长沟壑，消除小孔，填补轮廓线中的断裂**

**膨胀运算的例子**：
结构元反射后，根据**$A$中元素**坐标对$\hat B$平移，若平移后的$(\hat B)_z$与$A$仍有交集则该元素属于膨胀结果集合
![膨胀](https://raw.githubusercontent.com/Yuppie898988/LearningNotes-images/main/images/7F5BE2CC3D0A033305B5B3A42B4BA1C5.png)
如上图所示，$A$的原点在左下角。$(0,0)$坐标的变换结果$(\hat B)_z=\{(-1,0),(0,0)\}$与$A$不相交，所以$(0,0)\not\in A\oplus B$。
而对于$(1,4)$坐标的变换结果$(\hat B)_z=\{(0,4),(1,4)\}$与$A$相交，则$(1,4)\in A\oplus B$。
